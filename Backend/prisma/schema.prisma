generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Partida {
  id          String   @id @db.Text @default(dbgenerated("gen_random_uuid()"))
  codigo      String   @db.Text @unique @default(dbgenerated("encode(gen_random_bytes(6), 'hex'::text)"))
  estado      String   @db.Text @default("lobby")
  rondaActual Int      @default(0)
  createdAt   DateTime @default(now())

  jugadores   Jugador[]
  rondas      Ronda[]
  decisiones  Decision[]
  resultados  ResultadoRonda[]

  @@map("Partida")
}

model Jugador {
  id        String   @id @default(cuid())
  nombre    String
  esBot     Boolean  @default(false)
  budget    BigInt   @default(0)
  createdAt DateTime @default(now())

  partidaId String
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  decisiones Decision[]

  @@unique([partidaId, nombre], name: "jugador_unico_por_partida")
  @@index([partidaId])
}

model Ronda {
  id        String   @id @default(cuid())
  numero    Int
  createdAt DateTime @default(now())

  partidaId String
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  decisiones Decision[]
  resultado  ResultadoRonda? // 1:1 (lado inverso)

  @@unique([partidaId, numero], name: "ronda_unica_por_partida")
  @@index([partidaId])
}

model Decision {
  id        String   @id @default(cuid())
  data      Json
  createdAt DateTime @default(now())

  jugadorId String
  jugador   Jugador @relation(fields: [jugadorId], references: [id], onDelete: Cascade)

  partidaId String
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  rondaId String
  ronda   Ronda  @relation(fields: [rondaId], references: [id], onDelete: Cascade)

  @@index([partidaId])
  @@index([rondaId])
  @@index([jugadorId])
}

model ResultadoRonda {
  id        String   @id @default(cuid())
  data      Json
  createdAt DateTime @default(now())

  partidaId String
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  rondaId String @unique // ← CLAVE: 1:1 necesita FK ÚNICA
  ronda   Ronda  @relation(fields: [rondaId], references: [id], onDelete: Cascade)

  @@unique([partidaId, rondaId], name: "resultado_unico_por_ronda")
  @@index([partidaId])
  @@index([rondaId])
}
