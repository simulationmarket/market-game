generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // Ruta relativa al propio directorio /prisma
  url      = "file:./dev.db"
}

model Partida {
  id          Int      @id @default(autoincrement())
  codigo      String   @unique
  estado      String
  rondaActual Int      @default(0)
  createdAt   DateTime @default(now())

  // Relaciones
  jugadores  Jugador[]
  rondas     Ronda[]
  decisiones Decision[]
  resultados ResultadoRonda[]
}

model Jugador {
  id        Int      @id @default(autoincrement())
  nombre    String
  esBot     Boolean  @default(false)
  budget    BigInt   @default(0)
  createdAt DateTime @default(now())

  partidaId Int
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  decisiones Decision[]

  @@unique([partidaId, nombre], name: "jugador_unico_por_partida")
  @@index([partidaId])
}

model Ronda {
  id        Int      @id @default(autoincrement())
  numero    Int
  createdAt DateTime @default(now())

  partidaId Int
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  decisiones Decision[]
  resultado  ResultadoRonda? // 1:1 (opcional desde Ronda)

  @@unique([partidaId, numero], name: "ronda_unica_por_partida")
  @@index([partidaId])
}

model Decision {
  id        Int      @id @default(autoincrement())
  data      Json
  createdAt DateTime @default(now())

  jugadorId Int
  jugador   Jugador @relation(fields: [jugadorId], references: [id], onDelete: Cascade)

  partidaId Int
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  rondaId Int
  ronda   Ronda @relation(fields: [rondaId], references: [id], onDelete: Cascade)

  @@index([partidaId])
  @@index([rondaId])
  @@index([jugadorId])
}

model ResultadoRonda {
  id        Int      @id @default(autoincrement())
  data      Json
  createdAt DateTime @default(now())

  partidaId Int
  partida   Partida @relation(fields: [partidaId], references: [id], onDelete: Cascade)

  rondaId Int   @unique // ← CLAVE: 1:1 necesita FK única
  ronda   Ronda @relation(fields: [rondaId], references: [id], onDelete: Cascade)

  @@unique([partidaId, rondaId], name: "resultado_unico_por_ronda")
  @@index([partidaId])
  @@index([rondaId])
}
